<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The Nexus Terminal</title>
    <link rel="icon" href="logo.jpg" type="image/jpeg" />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=VT323&display=swap"
    />
    <style>
      :root {
        --bg: #050505;
        --panel: #1a1a1a;
        --cyan: #00f3ff;
        --purple: #bd00ff;
        --green: #00ff6a;
        --danger: #ff3b6a;
        --text: #d7f8ff;
        --muted: #7be7ff;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        font-family: "VT323", "Courier New", monospace;
        background: radial-gradient(
            circle at 12% 12%,
            rgba(0, 243, 255, 0.18),
            transparent 45%
          ),
          radial-gradient(
            circle at 85% 18%,
            rgba(189, 0, 255, 0.14),
            transparent 40%
          ),
          linear-gradient(140deg, #050505 10%, #0b0b0b 45%, #050505 100%);
        color: var(--text);
        letter-spacing: 0.6px;
        transition: transform 0.6s ease;
        transform-origin: center;
      }

      body.override {
        transform: rotate(180deg);
      }

      .scanlines {
        position: fixed;
        inset: 0;
        pointer-events: none;
        background: repeating-linear-gradient(
          to bottom,
          rgba(255, 255, 255, 0.04),
          rgba(255, 255, 255, 0.02) 2px,
          rgba(0, 0, 0, 0.12) 4px
        );
        mix-blend-mode: overlay;
        opacity: 0.3;
        z-index: 5;
      }

      .app {
        max-width: 1280px;
        margin: 0 auto;
        padding: 32px 24px 110px;
      }

      header {
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-bottom: 24px;
        text-transform: uppercase;
      }

      header h1 {
        margin: 0;
        font-size: 40px;
        color: var(--cyan);
        text-shadow: 0 0 18px rgba(0, 243, 255, 0.6);
      }

      header p {
        margin: 0;
        color: var(--muted);
        font-size: 18px;
      }

      .grid {
        display: grid;
        grid-template-columns: 3fr 2fr;
        gap: 20px;
      }

      .panel {
        background: linear-gradient(160deg, #141414, #0f0f0f 60%, #131313);
        border: 1px solid rgba(0, 243, 255, 0.4);
        box-shadow: 0 0 24px rgba(0, 243, 255, 0.08);
        padding: 20px;
        position: relative;
        overflow: hidden;
      }

      .panel::before {
        content: "";
        position: absolute;
        inset: 0;
        border: 1px solid rgba(189, 0, 255, 0.25);
        pointer-events: none;
      }

      .panel h2 {
        margin: 0 0 12px;
        font-size: 26px;
        color: var(--cyan);
        text-shadow: 0 0 10px rgba(0, 243, 255, 0.6);
      }

      .memory-input {
        display: flex;
        gap: 10px;
        margin-bottom: 16px;
      }

      input[type="text"],
      textarea {
        width: 100%;
        background: #0a0a0a;
        border: 1px solid rgba(0, 243, 255, 0.5);
        color: var(--text);
        padding: 10px 12px;
        font-family: inherit;
        font-size: 18px;
        outline: none;
        box-shadow: inset 0 0 8px rgba(0, 243, 255, 0.2);
      }

      textarea {
        min-height: 120px;
        resize: vertical;
      }

      button,
      .btn {
        background: #0c0c0c;
        border: 1px solid rgba(189, 0, 255, 0.7);
        color: var(--text);
        padding: 10px 14px;
        font-family: inherit;
        font-size: 18px;
        cursor: pointer;
        text-transform: uppercase;
        position: relative;
        overflow: hidden;
        transition: transform 0.2s ease, box-shadow 0.2s ease,
          border-color 0.2s ease;
        box-shadow: 0 0 10px rgba(189, 0, 255, 0.35);
      }

      button:hover,
      .btn:hover {
        border-color: var(--cyan);
        box-shadow: 0 0 18px rgba(0, 243, 255, 0.45);
        transform: translateY(-1px);
        animation: glitch 0.6s infinite;
      }

      .btn.secondary {
        border-color: rgba(0, 243, 255, 0.55);
        box-shadow: 0 0 10px rgba(0, 243, 255, 0.25);
      }

      .btn.secondary:hover {
        border-color: var(--purple);
        box-shadow: 0 0 18px rgba(189, 0, 255, 0.45);
      }

      .memory-hint {
        margin-bottom: 10px;
        color: var(--muted);
      }

      .data-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
      }

      .data-block {
        border: 1px solid rgba(0, 243, 255, 0.45);
        background: rgba(8, 8, 8, 0.9);
        padding: 10px;
        min-height: 110px;
        position: relative;
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        box-shadow: 0 0 12px rgba(0, 243, 255, 0.2);
        display: flex;
        flex-direction: column;
      }

      .data-block.code {
        border-color: rgba(189, 0, 255, 0.8);
        box-shadow: 0 0 12px rgba(189, 0, 255, 0.3);
      }

      .data-block.link {
        border-color: rgba(0, 243, 255, 0.9);
      }

      .data-block:hover {
        transform: translateY(-2px);
        box-shadow: 0 0 16px rgba(0, 243, 255, 0.45);
      }

      .block-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 16px;
        margin-bottom: 6px;
        color: var(--muted);
        gap: 8px;
      }

      .block-meta {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .block-flag {
        font-size: 14px;
        color: var(--cyan);
        text-shadow: 0 0 6px rgba(0, 243, 255, 0.8);
      }

      .block-flag.code {
        color: var(--purple);
      }

      .block-actions {
        display: inline-flex;
        align-items: center;
        gap: 6px;
      }

      .icon-btn {
        width: 32px;
        height: 26px;
        padding: 0;
        font-size: 16px;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: #0c0c0c;
        border: 1px solid rgba(0, 243, 255, 0.6);
        color: var(--cyan);
        box-shadow: 0 0 8px rgba(0, 243, 255, 0.25);
      }

      .icon-btn.qr-btn {
        color: var(--cyan);
      }

      .icon-btn.delete-btn {
        border-color: rgba(255, 59, 106, 0.8);
        color: var(--danger);
        box-shadow: 0 0 8px rgba(255, 59, 106, 0.35);
      }

      .icon-btn:hover {
        border-color: var(--purple);
        color: var(--purple);
        box-shadow: 0 0 12px rgba(189, 0, 255, 0.35);
      }

      .icon-btn.delete-btn:hover {
        border-color: var(--danger);
        color: var(--danger);
        box-shadow: 0 0 12px rgba(255, 59, 106, 0.55);
      }
      .block-content {
        font-size: 18px;
        white-space: pre-wrap;
        word-break: break-word;
        margin-top: auto;
      }

      .shatter {
        animation: shatter 0.35s forwards;
      }

      .cipher-tabs {
        display: flex;
        gap: 8px;
        margin-bottom: 16px;
        flex-wrap: wrap;
      }

      .panel-tabs {
        margin-bottom: 18px;
      }

      .panel-tabs .tab-btn {
        letter-spacing: 1px;
      }

      .tab-btn.active {
        border-color: var(--cyan);
        box-shadow: 0 0 16px rgba(0, 243, 255, 0.4);
      }

      .mode-panel {
        display: none;
      }

      .mode-panel.active {
        display: block;
      }

      .field {
        margin-bottom: 14px;
      }

      .field label {
        display: block;
        margin-bottom: 6px;
        color: var(--muted);
      }

      .file-actions {
        display: flex;
        align-items: center;
        gap: 8px;
        flex-wrap: wrap;
      }

      .file-label {
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .file-input {
        display: none;
      }

      .preview {
        width: 100%;
        max-height: 200px;
        object-fit: contain;
        border: 1px solid rgba(0, 243, 255, 0.35);
        background: #050505;
        margin-top: 10px;
        box-shadow: 0 0 14px rgba(0, 243, 255, 0.2);
      }

      .preview.hidden {
        display: none;
      }

      .output {
        background: #0a0a0a;
        border: 1px solid rgba(189, 0, 255, 0.6);
        padding: 12px;
        min-height: 120px;
        white-space: pre-wrap;
        font-size: 18px;
        position: relative;
      }

      .output.typing::after {
        content: "|";
        margin-left: 6px;
        animation: blink 0.9s infinite;
        color: var(--green);
      }

      .transmute-grid {
        display: grid;
        gap: 12px;
      }

      .trans-output {
        background: #0a0a0a;
        border: 1px solid rgba(0, 243, 255, 0.45);
        padding: 10px 12px;
        min-height: 80px;
        font-size: 16px;
        white-space: pre-wrap;
        word-break: break-word;
        box-shadow: inset 0 0 8px rgba(0, 243, 255, 0.18);
      }

      .trans-output.flicker {
        animation: flicker 0.25s steps(2, end) 2;
      }

      .download-link {
        display: inline-flex;
        margin-top: 10px;
        color: var(--green);
        text-decoration: none;
        font-size: 18px;
        text-shadow: 0 0 8px rgba(0, 255, 106, 0.7);
      }

      .download-link.disabled {
        opacity: 0.5;
        pointer-events: none;
      }

      .toast {
        position: fixed;
        left: 50%;
        bottom: 90px;
        transform: translateX(-50%) translateY(20px);
        background: rgba(0, 0, 0, 0.85);
        border: 1px solid rgba(0, 255, 106, 0.8);
        color: var(--green);
        padding: 10px 16px;
        font-size: 18px;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease, transform 0.2s ease;
        box-shadow: 0 0 16px rgba(0, 255, 106, 0.5);
        z-index: 20;
      }

      .toast.show {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
      }

      .net-ghost {
        position: fixed;
        top: 12px;
        right: 16px;
        padding: 10px 12px;
        font-size: 14px;
        color: var(--text);
        background: rgba(5, 5, 5, 0.7);
        border: 1px solid rgba(0, 243, 255, 0.35);
        box-shadow: 0 0 16px rgba(0, 243, 255, 0.15);
        z-index: 25;
        min-width: 180px;
      }

      .ghost-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 6px;
        color: var(--cyan);
        text-shadow: 0 0 8px rgba(0, 243, 255, 0.5);
      }

      .ghost-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: var(--green);
        box-shadow: 0 0 10px rgba(0, 255, 106, 0.7);
        animation: pulse 1.5s ease-in-out infinite;
      }

      .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.78);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.2s ease;
        z-index: 40;
        padding: 16px;
      }

      .modal.active {
        opacity: 1;
        pointer-events: auto;
      }

      .modal-panel {
        width: min(360px, 92vw);
        background: linear-gradient(160deg, #0e0e0e, #070707);
        border: 1px solid rgba(0, 243, 255, 0.6);
        box-shadow: 0 0 20px rgba(0, 243, 255, 0.25);
        padding: 18px;
        position: relative;
        overflow: hidden;
      }

      .modal-panel h3 {
        margin: 0 0 6px;
        color: var(--cyan);
      }

      .modal-panel p {
        margin: 0 0 12px;
        color: var(--muted);
      }

      .modal-panel::before,
      .modal-panel::after {
        content: "";
        position: absolute;
        inset: -2px;
        opacity: 0;
        pointer-events: none;
        mix-blend-mode: screen;
        background: linear-gradient(
          120deg,
          rgba(0, 243, 255, 0.25),
          rgba(189, 0, 255, 0.22)
        );
      }

      .modal-panel.glitch-in {
        animation: glitch-in 0.45s steps(2, end);
      }

      .modal-panel.glitch-in::before {
        animation: rgb-shift 0.35s ease;
      }

      .modal-panel.glitch-in::after {
        animation: rgb-shift 0.35s ease 0.1s;
      }

      .modal-close {
        position: absolute;
        top: 10px;
        right: 10px;
        width: 28px;
        height: 28px;
        padding: 0;
      }

      .qr-image {
        width: 150px;
        height: 150px;
        border: 1px solid rgba(0, 243, 255, 0.6);
        background: #050505;
        margin-bottom: 12px;
        box-shadow: 0 0 12px rgba(0, 243, 255, 0.35);
      }

      .qr-text {
        font-size: 16px;
        background: rgba(0, 0, 0, 0.6);
        border: 1px solid rgba(189, 0, 255, 0.4);
        padding: 8px;
        max-height: 120px;
        overflow: auto;
        white-space: pre-wrap;
      }

      .override-modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.92);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s ease;
        z-index: 60;
        padding: 20px;
      }

      .override-modal.active {
        opacity: 1;
        pointer-events: auto;
      }

      .override-panel {
        border: 1px solid rgba(0, 255, 106, 0.7);
        padding: 24px;
        max-width: 720px;
        text-align: center;
        background: rgba(0, 10, 0, 0.6);
        box-shadow: 0 0 20px rgba(0, 255, 106, 0.3);
      }

      .override-title {
        font-size: 20px;
        color: var(--green);
        text-shadow: 0 0 12px rgba(0, 255, 106, 0.6);
      }

      .sonic-footer {
        position: fixed;
        left: 0;
        right: 0;
        bottom: 0;
        height: 60px;
        background: rgba(5, 5, 5, 0.92);
        border-top: 1px solid rgba(0, 243, 255, 0.4);
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 16px;
        z-index: 15;
        gap: 12px;
      }

      .sonic-footer canvas {
        position: absolute;
        inset: 0;
        width: 100%;
        height: 60px;
        pointer-events: none;
      }

      .footer-label {
        position: relative;
        z-index: 1;
        color: var(--cyan);
        text-shadow: 0 0 10px rgba(0, 243, 255, 0.6);
        font-size: 18px;
      }

      .footer-controls {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .footer-btn {
        font-size: 16px;
        padding: 6px 10px;
      }

      .audio-status {
        font-size: 16px;
        color: var(--muted);
      }

      @keyframes glitch {
        0% {
          text-shadow: 2px 0 rgba(0, 243, 255, 0.8),
            -2px 0 rgba(189, 0, 255, 0.6);
        }
        50% {
          text-shadow: -2px -1px rgba(0, 243, 255, 0.8),
            2px 1px rgba(189, 0, 255, 0.6);
        }
        100% {
          text-shadow: 1px 0 rgba(0, 243, 255, 0.8),
            -1px 0 rgba(189, 0, 255, 0.6);
        }
      }

      @keyframes glitch-in {
        0% {
          opacity: 0;
          transform: translate(-12px, -8px) skewX(6deg);
          clip-path: polygon(0 2%, 100% 0, 100% 14%, 0 18%);
        }
        40% {
          opacity: 0.6;
          transform: translate(10px, 4px) skewX(-4deg);
          clip-path: polygon(0 32%, 100% 28%, 100% 42%, 0 46%);
        }
        70% {
          opacity: 0.9;
          transform: translate(-6px, 2px) skewX(2deg);
          clip-path: polygon(0 60%, 100% 58%, 100% 76%, 0 72%);
        }
        100% {
          opacity: 1;
          transform: translate(0, 0) skewX(0);
          clip-path: inset(0 0 0 0);
        }
      }

      @keyframes rgb-shift {
        0% {
          opacity: 0.9;
          transform: translate(-6px, 2px);
        }
        100% {
          opacity: 0;
          transform: translate(6px, -2px);
        }
      }

      @keyframes shatter {
        to {
          opacity: 0;
          transform: translateY(12px) scale(0.96) rotate(1deg);
          filter: blur(2px);
        }
      }

      @keyframes flicker {
        0% {
          opacity: 0.6;
          text-shadow: 0 0 6px rgba(0, 243, 255, 0.7);
        }
        100% {
          opacity: 1;
          text-shadow: none;
        }
      }

      @keyframes blink {
        0%,
        100% {
          opacity: 1;
        }
        50% {
          opacity: 0;
        }
      }

      @keyframes pulse {
        0%,
        100% {
          transform: scale(1);
          opacity: 0.7;
        }
        50% {
          transform: scale(1.4);
          opacity: 1;
        }
      }

      @media (max-width: 900px) {
        .grid {
          grid-template-columns: 1fr;
        }

        header h1 {
          font-size: 32px;
        }

        .memory-input {
          flex-direction: column;
        }

        .sonic-footer {
          flex-direction: column;
          justify-content: center;
          gap: 6px;
          padding: 6px 12px;
          height: 80px;
        }

        .sonic-footer canvas {
          height: 80px;
        }

        .net-ghost {
          top: 8px;
          right: 8px;
          font-size: 12px;
          min-width: 150px;
        }
      }
    </style>
  </head>
  <body>
    <div class="scanlines"></div>
    <div id="netGhost" class="net-ghost">
      <div class="ghost-header">
        <span class="ghost-dot"></span>
        NET GHOST PROBE
      </div>
      <div id="ipLine">IP: LOADING...</div>
      <div id="locLine">LOC: UNKNOWN</div>
      <div id="latencyLine">LATENCY: 24ms</div>
    </div>

    <div class="app">
      <header>
        <h1>The Nexus Terminal</h1>
        <p>神经核心终端 · 挥发记忆池与密码信道并行运行</p>
      </header>

      <div class="grid">
        <section class="panel">
          <h2>Volatile Memory Pool / 挥发记忆池</h2>
          <div class="memory-input">
            <input
              id="memoryInput"
              type="text"
              placeholder="输入内容后按 Enter 保存..."
              autocomplete="off"
            />
            <button id="addMemory">写入</button>
          </div>
          <div class="memory-hint">左键复制 · 右键删除 · QR 同步</div>
          <div id="memoryGrid" class="data-grid"></div>
        </section>

        <section class="panel">
          <h2>Cipher Channel / 密码信道</h2>
          <div class="cipher-tabs panel-tabs">
            <button class="tab-btn panel-tab active" data-panel="cipher">
              CIPHER
            </button>
            <button class="tab-btn panel-tab" data-panel="transmute">
              TRANSMUTE
            </button>
          </div>

          <div id="cipherPanel" class="mode-panel active">
            <div class="cipher-tabs">
              <button class="tab-btn cipher-tab active" data-mode="inject">
                INJECT
              </button>
              <button class="tab-btn cipher-tab" data-mode="extract">
                EXTRACT
              </button>
            </div>

            <div id="injectPanel" class="mode-panel active">
              <div class="field">
                <label>1. 上传载体图片</label>
                <div class="file-actions">
                  <label class="btn file-label">
                    选择图片
                    <input
                      id="injectFile"
                      class="file-input"
                      type="file"
                      accept="image/*"
                    />
                  </label>
                  <button id="injectClear" class="btn secondary" type="button">
                    清除
                  </button>
                </div>
                <div id="injectCapacity" class="memory-hint"></div>
                <img id="injectPreview" class="preview hidden" alt="预览" />
              </div>
              <div class="field">
                <label>2. 输入需要隐藏的文本</label>
                <textarea
                  id="secretInput"
                  placeholder="在这里输入秘密讯息..."
                ></textarea>
              </div>
              <button id="injectBtn">注入并生成</button>
              <a
                id="downloadLink"
                class="download-link disabled"
                href="#"
                download
              >
                下载隐写图像
              </a>
            </div>

            <div id="extractPanel" class="mode-panel">
              <div class="field">
                <label>1. 上传已注入的图片</label>
                <div class="file-actions">
                  <label class="btn file-label">
                    选择图片
                    <input
                      id="extractFile"
                      class="file-input"
                      type="file"
                      accept="image/*"
                    />
                  </label>
                  <button id="extractClear" class="btn secondary" type="button">
                    清除
                  </button>
                </div>
              </div>
              <div class="field">
                <label>2. 解析出的隐藏内容</label>
                <div id="extractOutput" class="output">等待图像输入...</div>
              </div>
            </div>
          </div>

          <div id="transmutePanel" class="mode-panel">
            <div class="field">
              <label>Raw Data Input / 原始数据输入</label>
              <textarea
                id="transmuteInput"
                placeholder="输入文本以转译..."
              ></textarea>
            </div>
            <div class="transmute-grid">
              <div class="field">
                <label>Hexadecimal / 十六进制</label>
                <div id="hexOutput" class="trans-output"></div>
              </div>
              <div class="field">
                <label>Binary / 二进制</label>
                <div id="binOutput" class="trans-output"></div>
              </div>
              <div class="field">
                <label>Base64 / 编码</label>
                <div id="base64Output" class="trans-output"></div>
              </div>
            </div>
          </div>
        </section>
      </div>
    </div>

    <div id="toast" class="toast">COPIED</div>

    <div id="qrModal" class="modal" aria-hidden="true">
      <div id="qrPanel" class="modal-panel" role="dialog" aria-modal="true">
        <button id="qrClose" class="btn secondary modal-close" type="button">
          X
        </button>
        <h3>Glitch QR Bridge</h3>
        <p>扫描以同步数据块。</p>
        <img id="qrImage" class="qr-image" alt="QR Code" />
        <div id="qrText" class="qr-text"></div>
      </div>
    </div>

    <div id="overrideModal" class="override-modal" aria-hidden="true">
      <div class="override-panel">
        <div class="override-title">
          SYSTEM OVERRIDE DETECTED. WELCOME, CREATOR from YUNNAN MINZU UNIVERSITY.
          ACCESS GRANTED.
        </div>
        <div style="margin-top: 16px">
          <button id="overrideClose" class="btn secondary" type="button">
            关闭
          </button>
        </div>
      </div>
    </div>

    <footer class="sonic-footer">
      <canvas id="sonicCanvas"></canvas>
      <div class="footer-label">SONIC VISUALIZER</div>
      <div class="footer-controls">
        <button id="audioToggle" class="btn footer-btn" type="button">
          INITIALIZE AUDIO
        </button>
        <div id="audioStatus" class="audio-status">AUDIO: OFFLINE</div>
      </div>
    </footer>

    <canvas id="stegCanvas" hidden></canvas>

    <script>
      const STORAGE_KEY = "nexus_memory_v1";
      const memoryInput = document.getElementById("memoryInput");
      const addMemoryBtn = document.getElementById("addMemory");
      const memoryGrid = document.getElementById("memoryGrid");
      const toast = document.getElementById("toast");

      const injectFile = document.getElementById("injectFile");
      const injectClear = document.getElementById("injectClear");
      const injectBtn = document.getElementById("injectBtn");
      const injectPreview = document.getElementById("injectPreview");
      const injectCapacity = document.getElementById("injectCapacity");
      const secretInput = document.getElementById("secretInput");
      const downloadLink = document.getElementById("downloadLink");

      const extractFile = document.getElementById("extractFile");
      const extractClear = document.getElementById("extractClear");
      const extractOutput = document.getElementById("extractOutput");

      const panelTabs = document.querySelectorAll(".panel-tab");
      const cipherPanel = document.getElementById("cipherPanel");
      const transmutePanel = document.getElementById("transmutePanel");
      const transmuteInput = document.getElementById("transmuteInput");
      const hexOutput = document.getElementById("hexOutput");
      const binOutput = document.getElementById("binOutput");
      const base64Output = document.getElementById("base64Output");

      const ipLine = document.getElementById("ipLine");
      const locLine = document.getElementById("locLine");
      const latencyLine = document.getElementById("latencyLine");

      const qrModal = document.getElementById("qrModal");
      const qrPanel = document.getElementById("qrPanel");
      const qrClose = document.getElementById("qrClose");
      const qrImage = document.getElementById("qrImage");
      const qrText = document.getElementById("qrText");

      const overrideModal = document.getElementById("overrideModal");
      const overrideClose = document.getElementById("overrideClose");

      const audioToggle = document.getElementById("audioToggle");
      const audioStatus = document.getElementById("audioStatus");
      const sonicCanvas = document.getElementById("sonicCanvas");
      const sonicCtx = sonicCanvas.getContext("2d");

      const canvas = document.getElementById("stegCanvas");
      const ctx = canvas.getContext("2d");

      let memoryList = [];
      let injectImageLoaded = false;
      let typeTimer = null;

      let audioCtx = null;
      let analyser = null;
      let dataArray = null;
      let audioActive = false;
      let fallbackPhase = 0;

      const isUrl = (text) => /^(https?:\/\/|www\.)/i.test(text.trim());
      const isCode = (text) =>
        /[{}`;]|<\/?[a-z][\s\S]*>|(function|const|let|var|=>|#include)/i.test(
          text
        );

      const showToast = (message, tone = "success") => {
        toast.textContent = message;
        toast.style.borderColor =
          tone === "danger" ? "rgba(255, 59, 106, 0.8)" : "rgba(0, 255, 106, 0.8)";
        toast.style.color = tone === "danger" ? "#ff3b6a" : "var(--green)";
        toast.classList.add("show");
        clearTimeout(showToast.timer);
        showToast.timer = setTimeout(() => toast.classList.remove("show"), 1600);
      };

      const saveMemory = () => {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(memoryList));
      };

      const renderMemory = () => {
        memoryGrid.innerHTML = "";
        if (!memoryList.length) {
          const empty = document.createElement("div");
          empty.className = "memory-hint";
          empty.textContent = "尚无数据块，输入内容后敲 Enter 写入。";
          memoryGrid.appendChild(empty);
          return;
        }

        memoryList.forEach((item, index) => {
          const block = document.createElement("div");
          block.className = "data-block";
          block.dataset.index = index;

          const tagParts = [];
          if (isUrl(item)) {
            block.classList.add("link");
            tagParts.push("URL");
          }
          if (isCode(item)) {
            block.classList.add("code");
            tagParts.push("CODE");
          }

          const head = document.createElement("div");
          head.className = "block-head";

          const meta = document.createElement("div");
          meta.className = "block-meta";
          const idSpan = document.createElement("span");
          idSpan.textContent = `#${String(index + 1).padStart(3, "0")}`;
          meta.appendChild(idSpan);

          if (tagParts.length) {
            tagParts.forEach((tag) => {
              const flag = document.createElement("span");
              flag.className = "block-flag" + (tag === "CODE" ? " code" : "");
              flag.textContent = tag;
              meta.appendChild(flag);
            });
          }

          const actions = document.createElement("div");
          actions.className = "block-actions";

          const qrBtn = document.createElement("button");
          qrBtn.type = "button";
          qrBtn.className = "icon-btn qr-btn";
          qrBtn.title = "生成 QR";
          qrBtn.textContent = "QR";
          qrBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            openQrModal(item);
          });

          const delBtn = document.createElement("button");
          delBtn.type = "button";
          delBtn.className = "icon-btn delete-btn";
          delBtn.title = "删除";
          delBtn.textContent = "X";
          delBtn.addEventListener("click", (event) => {
            event.stopPropagation();
            deleteBlock(block);
          });

          actions.appendChild(qrBtn);
          actions.appendChild(delBtn);

          head.appendChild(meta);
          head.appendChild(actions);

          const content = document.createElement("div");
          content.className = "block-content";
          content.textContent =
            item.length > 140 ? `${item.slice(0, 140)}...` : item;
          content.title = item;

          block.appendChild(head);
          block.appendChild(content);

          block.addEventListener("click", () => copyToClipboard(item));
          block.addEventListener("contextmenu", (event) => {
            event.preventDefault();
            deleteBlock(block);
          });

          memoryGrid.appendChild(block);
        });
      };

      const copyToClipboard = async (text) => {
        try {
          if (navigator.clipboard && window.isSecureContext) {
            await navigator.clipboard.writeText(text);
          } else {
            const temp = document.createElement("textarea");
            temp.value = text;
            document.body.appendChild(temp);
            temp.select();
            document.execCommand("copy");
            document.body.removeChild(temp);
          }
          showToast("COPIED: 已写入剪贴板");
        } catch (error) {
          showToast("复制失败，请重试", "danger");
        }
      };

      const deleteBlock = (block) => {
        const index = Number(block.dataset.index);
        block.classList.add("shatter");
        block.addEventListener(
          "animationend",
          () => {
            memoryList.splice(index, 1);
            saveMemory();
            renderMemory();
          },
          { once: true }
        );
      };

      const addMemory = () => {
        const text = memoryInput.value.trim();
        if (!text) {
          return;
        }
        memoryList.unshift(text);
        memoryInput.value = "";
        saveMemory();
        renderMemory();
      };

      addMemoryBtn.addEventListener("click", addMemory);
      memoryInput.addEventListener("keydown", (event) => {
        if (event.key === "Enter") {
          event.preventDefault();
          addMemory();
        }
      });

      const loadMemory = () => {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          try {
            const parsed = JSON.parse(saved);
            if (Array.isArray(parsed)) {
              memoryList = parsed;
            }
          } catch (error) {
            memoryList = [];
          }
        }
        renderMemory();
      };

      const openQrModal = (text) => {
        const encoded = encodeURIComponent(text);
        qrImage.src = `https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=${encoded}`;
        qrText.textContent = text;
        qrModal.classList.add("active");
        qrModal.setAttribute("aria-hidden", "false");
        qrPanel.classList.remove("glitch-in");
        void qrPanel.offsetWidth;
        qrPanel.classList.add("glitch-in");
      };

      const closeQrModal = () => {
        qrModal.classList.remove("active");
        qrModal.setAttribute("aria-hidden", "true");
      };

      qrClose.addEventListener("click", closeQrModal);
      qrModal.addEventListener("click", (event) => {
        if (event.target === qrModal) {
          closeQrModal();
        }
      });

      panelTabs.forEach((btn) => {
        btn.addEventListener("click", () => {
          panelTabs.forEach((item) => item.classList.remove("active"));
          btn.classList.add("active");
          const panel = btn.dataset.panel;
          cipherPanel.classList.toggle("active", panel === "cipher");
          transmutePanel.classList.toggle("active", panel === "transmute");
        });
      });

      document.querySelectorAll(".cipher-tab").forEach((btn) => {
        btn.addEventListener("click", () => {
          document
            .querySelectorAll(".cipher-tab")
            .forEach((item) => item.classList.remove("active"));
          btn.classList.add("active");

          const mode = btn.dataset.mode;
          document.getElementById("injectPanel").classList.toggle(
            "active",
            mode === "inject"
          );
          document.getElementById("extractPanel").classList.toggle(
            "active",
            mode === "extract"
          );
        });
      });

      const loadImageToCanvas = (file, callback, previewEl) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            canvas.width = img.width;
            canvas.height = img.height;
            ctx.drawImage(img, 0, 0);
            callback(img);
          };
          img.src = reader.result;
          if (previewEl) {
            previewEl.src = reader.result;
            previewEl.classList.remove("hidden");
          }
        };
        reader.readAsDataURL(file);
      };

      const getCapacityBytes = () => {
        const totalBits = canvas.width * canvas.height * 3;
        return Math.max(0, Math.floor((totalBits - 32) / 8));
      };

      const encodeLSB = (imageData, payload) => {
        const data = imageData.data;
        const capacityBits = (data.length / 4) * 3;
        const totalBits = 32 + payload.length * 8;
        if (totalBits > capacityBits) {
          throw new Error("超出容量");
        }

        let bitIndex = 0;
        const writeBit = (bit) => {
          const channelIndex = bitIndex % 3;
          const pixelIndex = Math.floor(bitIndex / 3);
          const dataIndex = pixelIndex * 4 + channelIndex;
          data[dataIndex] = (data[dataIndex] & 0xfe) | bit;
          bitIndex += 1;
        };

        for (let i = 31; i >= 0; i -= 1) {
          writeBit((payload.length >> i) & 1);
        }

        payload.forEach((byte) => {
          for (let i = 7; i >= 0; i -= 1) {
            writeBit((byte >> i) & 1);
          }
        });

        return imageData;
      };

      const decodeLSB = (imageData) => {
        const data = imageData.data;
        const capacityBits = (data.length / 4) * 3;
        if (capacityBits < 32) {
          throw new Error("图像尺寸过小");
        }

        const readBit = (bitIndex) => {
          const channelIndex = bitIndex % 3;
          const pixelIndex = Math.floor(bitIndex / 3);
          const dataIndex = pixelIndex * 4 + channelIndex;
          return data[dataIndex] & 1;
        };

        let length = 0;
        for (let i = 0; i < 32; i += 1) {
          length = (length << 1) | readBit(i);
        }

        const totalBits = 32 + length * 8;
        if (totalBits > capacityBits) {
          throw new Error("未检测到有效内容");
        }

        const bytes = new Uint8Array(length);
        let offset = 32;
        for (let i = 0; i < length; i += 1) {
          let value = 0;
          for (let bit = 0; bit < 8; bit += 1) {
            value = (value << 1) | readBit(offset + bit);
          }
          bytes[i] = value;
          offset += 8;
        }

        return new TextDecoder().decode(bytes);
      };

      const bytesToHex = (bytes) =>
        Array.from(bytes)
          .map((byte) => byte.toString(16).padStart(2, "0"))
          .join(" ");

      const bytesToBin = (bytes) =>
        Array.from(bytes)
          .map((byte) => byte.toString(2).padStart(8, "0"))
          .join(" ");

      const bytesToBase64 = (bytes) => {
        if (!bytes.length) {
          return "";
        }
        let binary = "";
        bytes.forEach((byte) => {
          binary += String.fromCharCode(byte);
        });
        return btoa(binary);
      };

      const triggerFlicker = (element) => {
        if (!element) {
          return;
        }
        element.classList.remove("flicker");
        void element.offsetWidth;
        element.classList.add("flicker");
        clearTimeout(element.flickerTimer);
        element.flickerTimer = setTimeout(
          () => element.classList.remove("flicker"),
          260
        );
      };

      const updateTransmute = () => {
        const text = transmuteInput.value;
        if (!text) {
          hexOutput.textContent = "";
          binOutput.textContent = "";
          base64Output.textContent = "";
          return;
        }
        const bytes = new TextEncoder().encode(text);
        hexOutput.textContent = bytesToHex(bytes);
        binOutput.textContent = bytesToBin(bytes);
        let base64 = "";
        try {
          base64 = bytesToBase64(bytes);
        } catch (error) {
          base64 = "";
        }
        base64Output.textContent = base64;
        [hexOutput, binOutput, base64Output].forEach(triggerFlicker);
      };

      const resetInject = () => {
        injectFile.value = "";
        injectPreview.src = "";
        injectPreview.classList.add("hidden");
        injectImageLoaded = false;
        injectCapacity.textContent = "";
        downloadLink.href = "#";
        downloadLink.classList.add("disabled");
      };

      const resetExtract = () => {
        extractFile.value = "";
        extractOutput.textContent = "等待图像输入...";
        extractOutput.classList.remove("typing");
        clearInterval(typeTimer);
        canvas.width = 0;
        canvas.height = 0;
      };

      injectFile.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) {
          return;
        }
        downloadLink.href = "#";
        downloadLink.classList.add("disabled");
        loadImageToCanvas(
          file,
          () => {
            injectImageLoaded = true;
            const capacity = getCapacityBytes();
            injectCapacity.textContent = `可容纳约 ${capacity} 字节数据`;
          },
          injectPreview
        );
      });

      injectBtn.addEventListener("click", () => {
        if (!injectImageLoaded) {
          showToast("请先选择图片", "danger");
          return;
        }
        const secret = secretInput.value;
        if (!secret.trim()) {
          showToast("请输入需要隐藏的文本", "danger");
          return;
        }

        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const bytes = new TextEncoder().encode(secret);
        try {
          const encoded = encodeLSB(imageData, bytes);
          ctx.putImageData(encoded, 0, 0);
          const url = canvas.toDataURL("image/png");
          downloadLink.href = url;
          downloadLink.classList.remove("disabled");
          showToast("注入完成，可下载图像");
        } catch (error) {
          alert("文本过长，超出图像容量！");
        }
      });

      downloadLink.addEventListener("click", (event) => {
        if (downloadLink.classList.contains("disabled")) {
          event.preventDefault();
        }
      });

      injectClear.addEventListener("click", resetInject);

      const typewriter = (element, text) => {
        clearInterval(typeTimer);
        element.textContent = "";
        element.classList.add("typing");
        let index = 0;
        typeTimer = setInterval(() => {
          element.textContent = text.slice(0, index);
          index += 1;
          if (index > text.length) {
            clearInterval(typeTimer);
            element.classList.remove("typing");
          }
        }, 30);
      };

      extractFile.addEventListener("change", (event) => {
        const file = event.target.files[0];
        if (!file) {
          return;
        }
        loadImageToCanvas(file, () => {
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          try {
            const message = decodeLSB(imageData);
            typewriter(
              extractOutput,
              message || "未检测到隐藏内容，可能为空或损坏。"
            );
          } catch (error) {
            typewriter(extractOutput, "解析失败：无法读取隐藏内容。");
          }
        });
      });

      extractClear.addEventListener("click", resetExtract);
      transmuteInput.addEventListener("input", updateTransmute);

      const resizeSonic = () => {
        const dpr = window.devicePixelRatio || 1;
        const rect = sonicCanvas.getBoundingClientRect();
        sonicCanvas.width = rect.width * dpr;
        sonicCanvas.height = rect.height * dpr;
        sonicCtx.setTransform(dpr, 0, 0, dpr, 0, 0);
      };

      const drawSonic = () => {
        requestAnimationFrame(drawSonic);
        const width = sonicCanvas.clientWidth;
        const height = sonicCanvas.clientHeight;
        if (!width || !height) {
          return;
        }

        sonicCtx.clearRect(0, 0, width, height);
        sonicCtx.fillStyle = "rgba(5, 5, 5, 0.85)";
        sonicCtx.fillRect(0, 0, width, height);

        sonicCtx.strokeStyle = "rgba(0, 243, 255, 0.12)";
        sonicCtx.lineWidth = 1;
        for (let i = 1; i <= 3; i += 1) {
          const y = (height / 4) * i;
          sonicCtx.beginPath();
          sonicCtx.moveTo(0, y);
          sonicCtx.lineTo(width, y);
          sonicCtx.stroke();
        }

        const barCount = dataArray ? dataArray.length : 64;
        const barWidth = width / barCount;

        if (analyser && audioCtx && audioCtx.state === "running") {
          analyser.getByteFrequencyData(dataArray);
        } else {
          if (!dataArray) {
            dataArray = new Uint8Array(64);
          }
          for (let i = 0; i < dataArray.length; i += 1) {
            dataArray[i] =
              40 +
              30 * Math.sin(fallbackPhase + i * 0.35) +
              12 * Math.sin(fallbackPhase * 0.6 + i * 0.15);
          }
          fallbackPhase += 0.04;
        }

        sonicCtx.shadowColor = "rgba(0, 243, 255, 0.6)";
        sonicCtx.shadowBlur = 10;
        sonicCtx.fillStyle = "rgba(0, 243, 255, 0.8)";

        for (let i = 0; i < barCount; i += 1) {
          const value = dataArray[i] / 255;
          const barHeight = Math.max(4, value * (height - 10));
          const x = i * barWidth;
          const y = height - barHeight;
          sonicCtx.fillRect(x, y, Math.max(1, barWidth - 1), barHeight);
        }

        sonicCtx.shadowBlur = 0;
      };

      const initAudio = () => {
        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 256;
        dataArray = new Uint8Array(analyser.frequencyBinCount);

        const masterGain = audioCtx.createGain();
        masterGain.gain.value = 0.08;

        const osc1 = audioCtx.createOscillator();
        osc1.type = "sawtooth";
        osc1.frequency.value = 70;

        const osc2 = audioCtx.createOscillator();
        osc2.type = "triangle";
        osc2.frequency.value = 112;

        const noiseBuffer = audioCtx.createBuffer(
          1,
          audioCtx.sampleRate * 2,
          audioCtx.sampleRate
        );
        const noiseData = noiseBuffer.getChannelData(0);
        for (let i = 0; i < noiseData.length; i += 1) {
          noiseData[i] = (Math.random() * 2 - 1) * 0.25;
        }
        const noise = audioCtx.createBufferSource();
        noise.buffer = noiseBuffer;
        noise.loop = true;
        const noiseGain = audioCtx.createGain();
        noiseGain.gain.value = 0.03;

        const lfo = audioCtx.createOscillator();
        lfo.frequency.value = 0.4;
        const lfoGain = audioCtx.createGain();
        lfoGain.gain.value = 0.02;

        lfo.connect(lfoGain);
        lfoGain.connect(masterGain.gain);

        osc1.connect(masterGain);
        osc2.connect(masterGain);
        noise.connect(noiseGain);
        noiseGain.connect(masterGain);

        masterGain.connect(analyser);
        analyser.connect(audioCtx.destination);

        osc1.start();
        osc2.start();
        noise.start();
        lfo.start();
      };

      const updateAudioUi = () => {
        audioToggle.textContent = audioActive ? "MUTE AUDIO" : "INITIALIZE AUDIO";
        audioStatus.textContent = audioActive ? "AUDIO: ONLINE" : "AUDIO: OFFLINE";
      };

      const toggleAudio = async () => {
        if (!audioCtx) {
          initAudio();
        }
        if (audioCtx.state === "suspended") {
          await audioCtx.resume();
          audioActive = true;
        } else {
          await audioCtx.suspend();
          audioActive = false;
        }
        updateAudioUi();
      };

      audioToggle.addEventListener("click", toggleAudio);

      const playBeep = () => {
        const ctxToUse = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
        const osc = ctxToUse.createOscillator();
        const gain = ctxToUse.createGain();
        osc.type = "square";
        osc.frequency.value = 880;
        gain.gain.value = 0.2;
        osc.connect(gain);
        gain.connect(ctxToUse.destination);
        ctxToUse.resume();
        osc.start();
        gain.gain.exponentialRampToValueAtTime(0.0001, ctxToUse.currentTime + 0.2);
        osc.stop(ctxToUse.currentTime + 0.25);
        if (!audioCtx) {
          osc.onended = () => ctxToUse.close();
        }
      };

      const konamiSequence = [
        "ArrowUp",
        "ArrowUp",
        "ArrowDown",
        "ArrowDown",
        "ArrowLeft",
        "ArrowRight",
        "ArrowLeft",
        "ArrowRight",
        "b",
        "a",
      ];
      let konamiIndex = 0;

      const normalizeKey = (key) =>
        key.startsWith("Arrow") ? key : key.toLowerCase();

      const triggerKonami = () => {
        playBeep();
        document.body.classList.add("override");
        overrideModal.classList.add("active");
        overrideModal.setAttribute("aria-hidden", "false");
      };

      document.addEventListener("keydown", (event) => {
        const key = normalizeKey(event.key);
        const expected = konamiSequence[konamiIndex];
        if (key === expected) {
          konamiIndex += 1;
          if (konamiIndex === konamiSequence.length) {
            konamiIndex = 0;
            triggerKonami();
          }
        } else {
          konamiIndex = key === konamiSequence[0] ? 1 : 0;
        }
      });

      const closeOverride = () => {
        overrideModal.classList.remove("active");
        overrideModal.setAttribute("aria-hidden", "true");
        document.body.classList.remove("override");
      };

      overrideClose.addEventListener("click", closeOverride);
      overrideModal.addEventListener("click", (event) => {
        if (event.target === overrideModal) {
          closeOverride();
        }
      });

      const updateLatency = () => {
        const value = Math.floor(18 + Math.random() * 60);
        latencyLine.textContent = `LATENCY: ${value}ms`;
      };

      const loadIpAddress = async () => {
        try {
          const response = await fetch("https://api.ipify.org?format=json");
          const data = await response.json();
          ipLine.textContent = `IP: ${data.ip || "UNKNOWN"}`;
        } catch (error) {
          ipLine.textContent = "IP: OFFLINE";
        }
      };

      updateLatency();
      setInterval(updateLatency, 2000);
      loadIpAddress();

      window.addEventListener("resize", resizeSonic);

      loadMemory();
      resetInject();
      resetExtract();
      updateTransmute();
      resizeSonic();
      drawSonic();
    </script>
  </body>
</html>
